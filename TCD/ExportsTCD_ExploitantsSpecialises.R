# Typologie basée sur les exploitants spécialisés

## Définir la table à merger (variable à ajouter)

presenceEspecesAnimaux <- paste0("PresenceAnimaux__", 1:8)
presenceTypeCulturesClassiques <- paste0("CulturesPresentes__", 1:8, "0")
presentePPAMHorsVanilleEtAutres <- paste0("TypePlantes__50", 1:8)

tableAMerger <- left_join(
  rga23_champ_Ile_Commune |> select(interview__key, Cultivateurs, Eleveurs, ProducteursCoprah),
  readCSV("rga23_tousFichiersPlats.csv"),
  by = "interview__key"
) |>
  mutate(
    nbElevages = rowSums(across(
      all_of(presenceEspecesAnimaux),
      ~ coalesce(., 0)
    )),
    nbTypesCultures = rowSums(across(
      all_of(presenceTypeCulturesClassiques),
      ~ coalesce(., 0)
    )),
    nbPPAMHorsVanille = rowSums(across(
      all_of(presentePPAMHorsVanilleEtAutres),
      ~ coalesce(., 0)
    ) + TypePlantes__511)
  ) |>
  mutate(TypeExploit = case_when(
    ProducteursCoprah == 0 & nbElevages == 1 & PresenceAnimaux__1 == 1 & nbTypesCultures == replace_na(CulturesPresentes__70, 0) & is.na(SurfaceJardins) ~ " - Bovins (avec éventuellement cultures fourragères)",
    ProducteursCoprah == 0 & ((nbElevages == 1 & (PresenceAnimaux__5 == 1 | PresenceAnimaux__8 == 1)) | (nbElevages == 2 & PresenceAnimaux__5 == 1 & PresenceAnimaux__8 == 1)) & nbTypesCultures == replace_na(CulturesPresentes__70, 0) & is.na(SurfaceJardins) ~ " - Caprins et/ou équidés (avec éventuellement cultures fourragères)",
    ProducteursCoprah == 0 & nbElevages == 1 & PresenceAnimaux__3 == 1 & nbTypesCultures == replace_na(CulturesPresentes__70, 0) & is.na(SurfaceJardins) ~ " - Porcins (avec éventuellement cultures fourragères)",
    ProducteursCoprah == 0 & nbElevages == 1 & PresenceAnimaux__4 == 1 & nbTypesCultures == 0 & is.na(SurfaceJardins) ~ " - Volailles",
    ProducteursCoprah == 0 & nbElevages == 1 & PresenceAnimaux__7 == 1 & nbTypesCultures == 0 & is.na(SurfaceJardins) ~ " - Abeilles",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__10 == 1 & is.na(SurfaceJardins) ~ " - Cultures maraichères",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__20 == 1 & is.na(SurfaceJardins) ~ " - Cultures vivrières",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__30 == 1 & is.na(SurfaceJardins) ~ " - Cultures fruitières", 
    ProducteursCoprah == 1 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__30 == 1 & is.na(SurfaceJardins) ~ " - Cultures fruitières et coprah",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__40 == 1 & is.na(SurfaceJardins) ~ " - Cultures florales",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__50 == 1 & nbPPAMHorsVanille == 0 & is.na(SurfaceJardins)  ~ " - Culture de vanille",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 1 & CulturesPresentes__50 == 1 & is.na(SurfaceJardins) ~ " - Cultures de plantes (hors exclusivité vanille)",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 0 & SurfaceJardins > 0 ~ " - Jardins océaniens",
    ProducteursCoprah == 1 & Eleveurs == 0 & Cultivateurs == 0 & is.na(SurfaceJardins) ~ " - Producteurs de coprah",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures == 2 & CulturesPresentes__20 == 1 & CulturesPresentes__30 == 1 & is.na(SurfaceJardins) ~ " - Cultures fruitières et vivrières",
    ProducteursCoprah == 0 & nbElevages == 0 & nbTypesCultures > 0 & is.na(SurfaceJardins) ~ " - Divers cultures classiques",
    ProducteursCoprah == 0 & nbElevages > 0 & nbTypesCultures == 0 & is.na(SurfaceJardins) ~ " - Divers élevages",
    TRUE ~ "AUTRE"
  )) 
# |>
#   select(interview__key, TypeExploit)

test <- tableAMerger |>
  filter(TypeExploit == "AUTRE" & nbElevages == 0 & nbTypesCultures == 2)

tableAMerger |>
  group_by(TypeExploit) |>
  count()

## Suffixe correspondant
suffixeNomTable <- "_ExploitantsSpecialises"

## Lancement du programme d'ajout de la colonne et d'export des différents CSV pour la constrution des TCD
source("TCD/AjoutColonneTypeExploitEtExportsCSV.R")
