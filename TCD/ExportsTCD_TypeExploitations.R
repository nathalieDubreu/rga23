## TODO :

### Définir la table à merger (variable à ajouter)
tableAMerger <- left_join(
  rga23_champ_Ile_Commune |> select(interview__key, Cultivateurs, Eleveurs, ProducteursCoprah),
  full_join(
    readCSV("rga23_prodVegetales.csv") |>
      select(interview__key, SurfaceJardins),
    readCSV("rga23_surfacesCultures.csv") |>
      filter(culture_id != 701 & culture_id != 702 & culture_id != 705 & culture_id != 307 & culture_id != 308 & culture_id != 309) |>
      group_by(interview__key) |>
      summarize(surface = sum(SurfaceCult, 0)),
    by = "interview__key"
  ) |>
    mutate(SurfaceCultVegetales = replace_na(surface, 0) + replace_na(SurfaceJardins, 0)) |>
    select(interview__key, SurfaceCultVegetales),
  by = "interview__key"
) |>
  mutate(TypeExploit = case_when(
    is.na(SurfaceCultVegetales) ~ "a - Aucune surface de cultures végétales",
    SurfaceCultVegetales == 0 ~ "a - Aucune surface de cultures végétales",
    SurfaceCultVegetales < 5000 ~ "b - Moins de 5000m2 de cultures végétales",
    SurfaceCultVegetales < 10000 ~ "c - Entre 5000m2 et 1Ha de cultures végétales",
    SurfaceCultVegetales >= 10000 ~ "d - 1Ha ou plus de cultures végétales",
  )) |>
  select(interview__key, TypeExploit)

### Suffixe correspondant
suffixeNomTable <- "_CategorieSurfaceCultVege_HC_HP"

nomsTablesTCD <- c("TCD1", "TCD2", "TCD3", "TCD4", "TCD5", "TCD6", "TCD7", "TCD8", "TCD9", "TCD10", "TCD11", "TCD12", "TCD13", "TCD14", "TCD15", "TCD16")
listeTablesTCD <- lapply(nomsTablesTCD, get)

for (i in seq_along(listeTablesTCD)) {
  table <- listeTablesTCD[[i]]
  nom_table <- nomsTablesTCD[i]

  table_resultat <- left_join(table |> select(-Ile, -Commune), tableAMerger, by = "interview__key")

  readr::write_csv2(
    table_resultat,
    file.path(
      Sys.getenv("cheminAcces"),
      "SortiesR",
      paste0(nom_table, suffixeNomTable, ".csv")
    ),
    append = FALSE,
    col_names = TRUE
  )
}
